{
  "body_html": "\n\n  \n    filter插件开发\n    \n    \n    \n    \n    \n  <link href=\"https://www.yuque.com/attachments/yuque/0/2020/css/491128/1588213910235-976bcd3a-7a9c-473d-b800-1b1df54807d4.css\" rel=\"stylesheet\" type=\"text/css\" />\n<link href=\"https://www.yuque.com/attachments/yuque/0/2020/css/491128/1588213910286-64db0dd0-ac29-46fb-9241-76ef318b1b53.css\" rel=\"stylesheet\" type=\"text/css\" />\n\n  \n        \n<div class=\"page\">\n    \n        <h1 class=\"book-chapter\" id=\"calibre_toc_26\">filter插件开发</h1>\n        <div class=\"section\">\n            <h2 id=\"修改1、生成filter插件工程\" class=\"calibre13\">修改1、生成filter插件工程</h2>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon logstash_plugin]# /opt/logstash/bin/logstash-plugin generate --type filter --name lynis  --path /opt/l\nogstash_plugin\n Creating /opt/logstash_plugin/logstash-filter-lynis\n     create logstash-filter-lynis/CHANGELOG.md\n     create logstash-filter-lynis/CONTRIBUTORS\n     create logstash-filter-lynis/DEVELOPER.md\n     create logstash-filter-lynis/Gemfile\n     create logstash-filter-lynis/LICENSE\n     create logstash-filter-lynis/README.md\n     create logstash-filter-lynis/Rakefile\n     create logstash-filter-lynis/lib/logstash/filters/lynis.rb\n     create logstash-filter-lynis/logstash-filter-lynis.gemspec\n     create logstash-filter-lynis/spec/filters/lynis_spec.rb\n     create logstash-filter-lynis/spec/spec_helper.rb\n[root@bogon logstash_plugin]# ll\ntotal 8\ndrwxr-xr-x. 4 root root 4096 9月  26 10:48 logstash-filter-lynis\ndrwxr-xr-x. 4 root root 4096 9月  26 10:47 logstash-filter-test\n[root@bogon logstash_plugin]#\n</code></pre><h2 id=\"2、修改代码\" class=\"calibre13\">2、修改代码</h2>\n<p class=\"calibre12\">文件：/opt/logstash_plugin/logstash-filter-lynis/lib/logstash/filters/lynis.rb</p>\n<ul class=\"calibre17\">\n<li class=\"calibre18\">增加类成员变量source：</li>\n</ul>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">class LogStash::Filters::Lynis &lt; LogStash::Filters::Base\n\n  # Setting the config_name here is required. This is how you\n  # configure this filter from your Logstash config.\n  #\n  # filter {\n  #    {\n  #     message =&gt; \"My message...\"\n  #   }\n  # }\n  #\n  config_name \"lynis\"\n\n  # Replace the message with this value.\n  #config :message, :validate =&gt; :string, :default =&gt; \"Hello World!\"\n  config :source, :validate =&gt; :string, :default =&gt; \"message\"\n</code></pre><ul class=\"calibre17\">\n<li class=\"calibre18\">修改filter函数：</li>\n</ul>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">  public\n  def filter(event)\n    source_value = event.get(@source)\n    index = source_value.index(\"=\")                                                              \n    source_len = source_value.length                                                             \n\n    if index!=nil &amp;&amp; index!=0                                                                    \n        dest_key = source_value[0, index]                                                        \n        dest_value = source_value[index+1, source_len]                                           \n\n        event.set(dest_key, dest_value)                                                          \n    end\n    # filter_matched should go in the last line of our successful code                           \n    filter_matched(event)\n end\n</code></pre><h2 id=\"3、修改配置信息\" class=\"calibre13\">3、修改配置信息</h2>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">root@bogon logstash-filter-lynis]# cat logstash-filter-lynis.gemspec \nGem::Specification.new do |s|\n  s.name          = 'logstash-filter-lynis'\n  s.version       = '1.1.0'\n  s.licenses      = ['Apache License (2.0)']\n  s.summary       = 'this plugin is used process lynis report data'\n  s.description   = 'Write a longer description or delete this line.'\n  s.homepage      = 'https://github.com/anbc'\n  s.authors       = ['anbc']\n  s.email         = 'anbingchun@163.com'\n  s.require_paths = ['lib']\n\n  # Files\n  s.files = Dir['lib/**/*','spec/**/*','vendor/**/*','*.gemspec','*.md','CONTRIBUTORS','Gemfile','LICENSE','NOTICE.TXT']\n   # Tests\n  s.test_files = s.files.grep(%r{^(test|spec|features)/})\n\n  # Special flag to let us know this is actually a logstash plugin\n  s.metadata = { \"logstash_plugin\" =&gt; \"true\", \"logstash_group\" =&gt; \"filter\" }\n\n  # Gem dependencies\n  s.add_runtime_dependency \"logstash-core-plugin-api\", \"~&gt; 2.0\"\n  s.add_development_dependency 'logstash-devutils'\nend\n</code></pre><h2 id=\"4、安装logstash-plugin需要的依赖\" class=\"calibre13\">4、安装Logstash plugin需要的依赖</h2>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">bundle install\n</code></pre><h2 id=\"5、使用spec进行单元测试\" class=\"calibre13\">5、使用spec进行单元测试</h2>\n<p class=\"calibre12\">通过编写单元测试代码完成单元测试工作，具体单元测试代码位于</p>\n<p class=\"calibre12\"><code class=\"pcalibre5 pcalibre6 calibre19\">/opt/logstash_plugin/logstash-filter-lynis/spec/filters/lynis_spec.rb</code></p>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\"># encoding: utf-8\nrequire_relative '../spec_helper'\nrequire \"logstash/filters/lynis\"\n\ndescribe LogStash::Filters::Lynis do\n  describe \"Set to Hello World\" do\n  #设置logstash的配置文件\n    let(:config) do &lt;&lt;-CONFIG\n      filter { #具体的filter\n        lynis {  #filter插件的名称\n          source =&gt; \"message\"  #将message字段的信息传入source中\n        }\n      }\n    CONFIG\n    end\n\n    #传入一条输入数据\n    sample(\"message\" =&gt; \"hello=world\") do #输入数据的key是message，value是hello=world。\n    #sample(\"hello=world\") do  #忽略key的表达方式\n      expect(subject).to include(\"hello\") #判断解析后的output数据中，是否包含key为hello的数据\n      expect(subject.get('hello')).to eq('world')#判断以hello为key的数据的值是否是world\n    end  \n  end   \nend\n</code></pre><h2 id class=\"calibre13\"> </h2>\n<h2 id=\"5、测试插件\" class=\"calibre8\">5、测试插件</h2>\n<p class=\"calibre12\">运行命令：</p>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">bundle exec rspec\n</code></pre><p class=\"calibre12\">运行结果：</p>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon logstash-filter-lynis]# bundle exec rspec\n--- jar coordinate com.fasterxml.jackson.core:jackson-databind already loaded with version 2.7.4 - omit version 2.9.1\n--- jar coordinate com.fasterxml.jackson.core:jackson-annotations already loaded with version 2.7.0 - omit version 2.9.1\n--- jar coordinate com.fasterxml.jackson.module:jackson-module-afterburner already loaded with version 2.7.4 - omit version 2.9.1\n--- jar coordinate com.fasterxml.jackson.core:jackson-core already loaded with version 2.7.4 - omit version 2.9.1\nERROR StatusLogger No log4j2 configuration file found. Using default configuration: logging only errors to the console.\nSending Logstash's logs to  which is now configured via log4j2.properties\nRun options: exclude {:redis=&gt;true, :socket=&gt;true, :performance=&gt;true, :couchdb=&gt;true, :elasticsearch=&gt;true, :elasticsearch_secure=&gt;true, :export_cypher=&gt;true, :integration=&gt;true, :windows=&gt;true}\n\nRandomized with seed 32702\n.\n\nFinished in 0.42843 seconds (files took 8.8 seconds to load)\n1 example, 0 failures\n\nRandomized with seed 32702\n</code></pre><h2 id=\"6、生成gem包\" class=\"calibre13\">6、生成gem包</h2>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon logstash-filter-lynis]# gem build logstash-filter-lynis.gemspec \n  Successfully built RubyGem\n  Name: logstash-filter-lynis\n  Version: 1.1.0\n  File: logstash-filter-lynis-1.1.0.gem\n[root@bogon logstash-filter-lynis]# ll\ntotal 44\n-rw-r--r--. 1 root root   63 9月  26 10:48 CHANGELOG.md\n-rw-r--r--. 1 root root  407 9月  26 10:48 CONTRIBUTORS\n-rw-r--r--. 1 root root  119 9月  26 10:48 DEVELOPER.md\n-rw-r--r--. 1 root root   39 9月  26 10:48 Gemfile\n-rw-r--r--. 1 root root 3043 9月  26 11:13 Gemfile.lock\ndrwxr-xr-x. 3 root root   21 9月  26 10:48 lib\n-rw-r--r--. 1 root root  524 9月  26 10:48 LICENSE\n-rw-r--r--. 1 root root 7680 9月  26 16:49 logstash-filter-lynis-1.1.0.gem\n-rw-r--r--. 1 root root  916 9月  26 11:12 logstash-filter-lynis.gemspec\n-rw-r--r--. 1 root root   33 9月  26 10:48 Rakefile\n-rw-r--r--. 1 root root 3032 9月  26 10:48 README.md\ndrwxr-xr-x. 3 root root   41 9月  26 14:04 spec\n[root@bogon logstash-filter-lynis]#\n</code></pre><h2 id=\"7、安装插件\" class=\"calibre13\">7、安装插件</h2>\n<ul class=\"calibre17\">\n<li class=\"calibre18\">手动安装logstash</li>\n</ul>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon opt]# tar -xvf logstash-5.6.1.tar.gz\n[root@bogon opt]# ln -s logstash-5.6.1.tar.gz  logstatsh\n</code></pre><ul class=\"calibre17\">\n<li class=\"calibre18\">查看当前插件</li>\n</ul>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon logstash-5.6.1]# ./bin/logstash-plugin list\nlogstash-codec-cef\nlogstash-codec-collectd\nlogstash-codec-dots\nlogstash-codec-edn\nlogstash-codec-edn_lines\nlogstash-codec-es_bulk\nlogstash-codec-fluent\nlogstash-codec-graphite\nlogstash-codec-json\n</code></pre><ul class=\"calibre17\">\n<li class=\"calibre18\">安装插件</li>\n</ul>\n<p class=\"calibre12\">由于gem文件路径错误，导致的错误提示</p>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon logstash-5.6.1]# /opt/logstash/bin/logstash-plugin install /opt/logstash_plugin/logtash-\nfilter-lynis/ogstash-filter-lynis-1.1.0.gem\nValidating /opt/logstash_plugin/logtash-filter-lynis/ogstash-filter-lynis-1.1.0.gem\nPlugin /opt/logstash_plugin/logtash-filter-lynis/ogstash-filter-lynis-1.1.0.gem does not exist\nERROR: Installation aborted, verification failed for /opt/logstash_plugin/logtash-filter-lynis/ogstash-filter-lynis-1.1.0.gem\n[root@bogon logstash-5.6.1]#\n</code></pre><p class=\"calibre12\">安装成功</p>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon logstash-filter-lynis]# /opt/logstash/bin/logstash-plugin install /opt/logstash_plugin/l\nogstash-filter-lynis/logstash-filter-lynis-1.1.0.gem\nValidating /opt/logstash_plugin/logstash-filter-lynis/logstash-filter-lynis-1.1.0.gem\nInstalling logstash-filter-lynis\n</code></pre><p class=\"calibre12\">执行上面命令时，会出现卡死现象，ctrl+c 终止后，安装正常。</p>\n<ul class=\"calibre17\">\n<li class=\"calibre18\">验证是否安装成功</li>\n</ul>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon local_gems]# /opt/logstash/bin/logstash-plugin list\n........\nlogstash-codec-netflow\nlogstash-codec-plain\nlogstash-codec-rubydebug\n...............\nlogstash-filter-fingerprint\nlogstash-filter-geoip\nlogstash-filter-grok\nlogstash-filter-json\nlogstash-filter-kv\nlogstash-filter-lynis  #新安装的lynis插件\nlogstash-filter-metrics\n..............\nlogstash-input-beats\nlogstash-input-couchdb_changes\nlogstash-input-dead_letter_q\n</code></pre><h2 id=\"8、修改logstash配置文件调用指定插件\" class=\"calibre13\">8、修改logstash配置文件调用指定插件</h2>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon config]# vim logstash.conf\n\n\ninput\n{\n    stdin{}\n\n}\n\n\nfilter\n{\n    lynis  \n    {\n        source =&gt; \"message\"\n        add_tag =&gt; [\"lynis_data\"]\n        #remove_field =&gt; [\"message\"]\n\n    }\n\n}\n\noutput\n{\n    stdout { codec =&gt; rubydebug }\n\n}\n</code></pre><h2 id=\"9、测试插件效果\" class=\"calibre13\">9、测试插件效果</h2>\n<ul class=\"calibre17\">\n<li class=\"calibre18\">运行logstash</li>\n</ul>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">[root@bogon config]# /opt/logstash/bin/logstash -f /opt/logstash/config/logstash.conf \n2017-09-26 18:05:45,183 main ERROR Unable to locate appender \"${sys:ls.log.format}_console\" for logger config \"root\"\n2017-09-26 18:05:45,184 main ERROR Unable to locate appender \"${sys:ls.log.format}_rolling\" for logger config \"root\"\n2017-09-\n</code></pre><ul class=\"calibre17\">\n<li class=\"calibre18\">数据解析情况</li>\n</ul>\n<pre class=\"calibre10\"><code class=\"pcalibre4 pcalibre3 calibre11\">#键盘输入内容\nhello=world  \n#数据解析\n{\n      \"@version\" =&gt; \"1\",\n          \"host\" =&gt; \"0.0.0.0\",\n    \"@timestamp\" =&gt; 2017-09-26T10:06:02.741Z,\n         \"hello\" =&gt; \"world\",\n       \"message\" =&gt; \"hello=world\",\n          \"tags\" =&gt; [\n        [0] \"lynis_data\"\n    ]\n}\n\n#键盘输入内容\ndddd \n#数据解析\n{\n      \"@version\" =&gt; \"1\",\n          \"host\" =&gt; \"0.0.0.0\",\n    \"@timestamp\" =&gt; 2017-09-26T10:06:06.321Z,\n       \"message\" =&gt; \"dddd\",\n          \"tags\" =&gt; [\n        [0] \"lynis_data\"\n    ]\n}\n\n#键盘输入内容\nos=linux=   \n#数据解析\n{\n      \"@version\" =&gt; \"1\",\n          \"host\" =&gt; \"0.0.0.0\",\n    \"@timestamp\" =&gt; 2017-09-26T10:06:20.110Z,\n       \"message\" =&gt; \"os=linux=\",\n            \"os\" =&gt; \"linux=\",\n          \"tags\" =&gt; [\n        [0] \"lynis_data\"\n    ]\n}\n\n#键盘数据内容\nddd=dd==dd\n#数据解析\n{\n      \"@version\" =&gt; \"1\",\n          \"host\" =&gt; \"0.0.0.0\",\n    \"@timestamp\" =&gt; 2017-09-26T10:06:30.725Z,\n       \"message\" =&gt; \"ddd=dd==dd\",\n           \"ddd\" =&gt; \"dd==dd\",\n          \"tags\" =&gt; [\n        [0] \"lynis_data\"\n    ]\n}\n</code></pre>\n        </div>\n    \n</div>\n\n        \n    \n\n\n\n",
  "slug": 6588890,
  "title": "filtercha-jian-kai-fa"
}