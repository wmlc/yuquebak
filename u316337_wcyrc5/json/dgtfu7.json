{
  "body_html": "<!doctype html><div class=\"lake-content-editor-core lake-engine lake-typography-traditional\" data-lake-element=\"root\"><p data-lake-id=\"7ca1bd23b4128f043589c908156c0103\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><h3 data-lake-id=\"4fa7fb2d80b22bd4fe0bc4e8228bcf32\" id=\"43MrG\" style=\"padding: 7px 0px; margin: 0px; font-weight: 700; font-size: 20px; line-height: 28px;\">禁用Cookie后实际情况</h3><p data-lake-id=\"6846dec5c9e15ce413104ea6ffe0e6a5\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">用户禁止cookie后，服务器仍会每次将sessionId以cookie的方式发送给浏览器，但浏览器不再保存这个cookie(即sessionId)了，从而导致每次发给服务端的sessionId都不一致</p><p data-lake-id=\"0933aa2eaf65de8df4de28fde567a42d\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><h3 data-lake-id=\"cf83823d9f4c25252ec7beb13b420124\" id=\"dzRh4\" style=\"padding: 7px 0px; margin: 0px; font-weight: 700; font-size: 20px; line-height: 28px;\">正常情况</h3><p data-lake-id=\"938014de5357ce1ce83d9130bea9e6cd\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"41d810931806e2569314d26f8076caaf\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">你第一次访问网站时，</p><p data-lake-id=\"11e29fcd16b1d9478c75f7cc0c618ea7\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"eef5caba543667e5d4bdd31d032b105e\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">服务端脚本中开启了Sessionsession_start();，</p><p data-lake-id=\"39cab34fbd735777ab309451e55063c9\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"818febff0905656fd10116cf0ae9afe3\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">服务器会生成一个不重复的 SESSIONID 的文件session_id();，比如在/var/lib/php/session目录</p><p data-lake-id=\"3c8c853698b4f1392b8e4be404865d8f\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"b9ef3bd1c7a268a1897eafa3f25f5c33\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">并将返回(Response)如下的HTTP头 Set-Cookie:PHPSESSIONID=xxxxxxx</p><p data-lake-id=\"0e4304161b827ba00d5b371fe589534e\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"488031c146cb043c78b8724d4984de2a\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">客户端接收到Set-Cookie的头，将PHPSESSIONID写入cookie</p><p data-lake-id=\"85b784279888514494eb0f31f96f5997\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"94441d7203d6615cdb72bd127b8f0db4\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">当你第二次访问页面时，所有Cookie会附带的请求头(Request)发送给服务器端</p><p data-lake-id=\"92a558637ca0b9688c7f033d7b0c6a30\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"51030ad7bde37dfc5840795cc64ee468\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">服务器识别PHPSESSIONID这个cookie，然后去session目录查找对应session文件，</p><p data-lake-id=\"51c298f5ed70470100fb740b8cac5fc1\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"3116384872ae168c0f7649dc6617caa2\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">找到这个session文件后，检查是否过期，如果没有过期，去读取Session文件中的配置；如果已经过期，清空其中的配置</p><p data-lake-id=\"2b7e8a9cad402deffb8282a41fa5708c\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"ddcfa77b57d554b51fc4d31a507c488b\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">如果客户端禁用了Cookie，那PHPSESSIONID都无法写入客户端，Session就不能用了。</p><p data-lake-id=\"199e88f2b971fbdaf86701c63d89c5b6\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"c2b1b67aa8a755ba39fccf594be3303d\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">并且服务端因为没有得到PHPSESSIONID的cookie，会不停的生成session_id文件</p><p data-lake-id=\"2670c91511963e02e0de9807533c08c4\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><h3 data-lake-id=\"5a77d9e3843c2af3bd2bc44298441fb7\" id=\"MZ4k5\" style=\"padding: 7px 0px; margin: 0px; font-weight: 700; font-size: 20px; line-height: 28px;\">解决方案</h3><p data-lake-id=\"adad03a36b699e78e3cebe1472e05083\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"284a17b7f6f1e882077f24cd69d6457c\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">1、取巧传递session_id</p><p data-lake-id=\"e24fc29774a186080f5eeadb811db597\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">但是这难不倒服务端程序，聪明的程序员想到，如果一个Cookie都没接收到，基本上可以预判客户端禁用了Cookie，那将session_id附带在每个网址后面(包括POST)，</p><p data-lake-id=\"34de66453787ea31c668fadc9e7c5a94\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">比如：</p><p data-lake-id=\"fccd000d582933823c4cd204ee202db5\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"a1071b2d1b0b911b28028d5e46e2c252\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">GET <a href=\"http://www.xx.com/index.php?session_id=xxxxx\" target=\"_blank\">http://www.xx.com/index.php?session_id=xxxxx</a></p><p data-lake-id=\"6eb64e71fc4ccc2f0ad31395d629450f\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">POST <a href=\"http://www.xx.com/post.php?session_id=xxxxx\" target=\"_blank\">http://www.xx.com/post.php?session_id=xxxxx</a></p><p data-lake-id=\"cc5041ab7a48e96978a266f863263eb7\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">然后在每个页面的开头使用session_id($_GET['session_id'])，来强制指定当前session_id</p><p data-lake-id=\"8b99c2c358e8cdf210cfc0a333590a95\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"f16ba38a98b2f3efd43e142c28125224\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">这样就可以了。</p><p data-lake-id=\"301a81c026837f3ffd75bc0cc6898a58\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"c6323c8ce9692e44f20dcaffedd7cc5c\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">聪明的你肯定想到，那将这个网站发送给别人，那么他将会以你的身份登录并做所有的事情</p><p data-lake-id=\"7c96a5b891e700228449b7bfd833a98b\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">（目前很多订阅公众号就将openid附带在网址后面，这是同样的漏洞）。</p><p data-lake-id=\"2efe9af6bc8ce2b94d43b235e3d962e0\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"34de4b1860977545b4938fe89d4d5d7b\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">其实不仅仅如此，cookie也可以被盗用，比如XSS注入，通过XSS漏洞获取大量的Cookie，也就是控制了大量的用户，腾讯有专门的XSS漏洞扫描机制，因为大量的QQ盗用，发广告就是因为XSS漏洞</p><p data-lake-id=\"c71cb45d03210e1ffc2bcccf5fb7185b\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"c000c703aa1273c3945871607160b21a\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">所以Laravel等框架中，内部实现了Session的所有逻辑，并将PHPSESSIONID设置为httponly并加密，这样，前端JS就无法读取和修改这些敏感信息，降低了被盗用的风险。</p><p data-lake-id=\"eaf9e20ae09d09c26380ef834b5dad7a\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"972195b1ef64682da73f5151bdb0629f\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">2、使用常量SID</p><p data-lake-id=\"2196d99e5ca4a86c2b3769f65889ae6e\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">常量SID相当于 “PHPSESSID=xxxxxxxxxxxxxxxxxxxxxxxxxxx”</p><p data-lake-id=\"f508490bbbfe630e1d14f8e9846e2c81\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">使用方法如下:</p><p data-lake-id=\"be9920e2b1a57356aadbd73880f00fde\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">在超链接 action &nbsp;header(“Location: xx”) 可以直接拼接 SID常量即可</p><p data-lake-id=\"2c59a23e1e34887b779dde9405a3c0d7\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\"><br></p><p data-lake-id=\"7432970ebab018b82f010493983a8ff4\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">3、可以配置 php.ini 文件,启用session.use_trans_sid 指定是否启用透明 SID 支持</p><p data-lake-id=\"1d98d1356c6cc518427b9e7f1b1ae956\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">即可以这样设置</p><p data-lake-id=\"c01264bb391f8a0462ec76a4b00c1f0b\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">ssssion. use_trans_sid = 1 ，这样重启apache即可生效.</p><p data-lake-id=\"61e027b7edea37bf7c3951575a9b6dfc\" style=\"font-size: 14px; color: rgb(38, 38, 38); line-height: 1.74; letter-spacing: 0.05em; outline-style: none; overflow-wrap: break-word; margin: 0px;\">设为1后，在href、action、header会自动加 SID ，但是js的跳转不会加</p></div>",
  "slug": 6390637,
  "title": "禁用Cookie时，PHP共享Session文件解决方案"
}